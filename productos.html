<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Listado de productos</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="wide">
    <div class="card">
      <div class="eyebrow">Panel</div>
      <h1>Listado de productos</h1>
      <p>Filtra y revisa todos los registros.</p>

      <form class="filters" action="#" method="get">
        <div class="field">
          <label for="campo">Filtrar por</label>
          <select id="campo" name="campo">
            <option value="">Todos los campos</option>
            <option value="nombre">Nombre</option>
            <option value="precio">Precio</option>
            <option value="cantidad">Cantidad</option>
            <option value="categoria">Categoria</option>
            <option value="subcategoria">Subcategoria</option>
            <option value="elaboracion">Fecha de elaboracion</option>
            <option value="vencimiento">Fecha de vencimiento</option>
            <option value="empaque">Empaque</option>
            <option value="presentacion">Presentacion</option>
            <option value="ingredientes">Ingredientes</option>
            <option value="canton">Canton de origen</option>
            <option value="provincia">Provincia de origen</option>
          </select>
        </div>
        <div class="field">
          <label for="valor">Valor</label>
          <input type="text" id="valor" name="valor" placeholder="Escribe tu filtro">
        </div>
        <button class="button secondary" type="submit">Aplicar filtro</button>
      </form>

      <div class="status" id="listStatus" role="status" aria-live="polite"></div>

      <div class="table-wrapper">
        <table class="table" aria-label="Tabla de productos">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Precio</th>
              <th>Cantidad</th>
              <th>Categoria</th>
              <th>Subcategoria</th>
              <th>Fecha elaboracion</th>
              <th>Fecha vencimiento</th>
              <th>Empaque</th>
              <th>Presentacion</th>
              <th>Ingredientes</th>
              <th>Canton</th>
              <th>Provincia</th>
            </tr>
          </thead>
          <tbody id="productosBody">
            <tr><td colspan="12">Cargando productos...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="actions">
        <a class="button secondary" href="index.html">Volver</a>
      </div>
    </div>
  </main>

  <script>
    const body = document.getElementById('productosBody');
    const listStatus = document.getElementById('listStatus');
    const filtersForm = document.querySelector('.filters');
    const columns = ['nombre','precio','cantidad','categoria','subcategoria','elaboracion','vencimiento','empaque','presentacion','ingredientes','canton','provincia'];
    let cache = [];

    const esc = (value) => String(value ?? '').replace(/[&<>"']/g, (char) => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[char]));

    const formatPrice = (value) => {
      const num = Number(value);
      return Number.isFinite(num) ? `$${num.toFixed(2)}` : esc(value);
    };

    const render = (items) => {
      body.innerHTML = '';
      if (!items.length) {
        body.innerHTML = '<tr><td colspan="12">No hay productos para mostrar.</td></tr>';
        return;
      }
      const rows = items.map((item) => `
        <tr>
          <td>${esc(item.nombre)}</td>
          <td>${formatPrice(item.precio)}</td>
          <td>${esc(item.cantidad)}</td>
          <td>${esc(item.categoria)}</td>
          <td>${esc(item.subcategoria)}</td>
          <td>${esc(item.fecha_elaboracion)}</td>
          <td>${esc(item.fecha_vencimiento)}</td>
          <td>${esc(item.empaque)}</td>
          <td>${esc(item.presentacion)}</td>
          <td>${esc(item.ingredientes)}</td>
          <td>${esc(item.canton)}</td>
          <td>${esc(item.provincia)}</td>
        </tr>
      `).join('');
      body.innerHTML = rows;
    };

    const applyFilter = () => {
      const campo = document.getElementById('campo').value;
      const valor = document.getElementById('valor').value.trim().toLowerCase();
      if (!valor) {
        render(cache);
        return;
      }
      if (campo) {
        const filtered = cache.filter((item) => String(item[campo] ?? '').toLowerCase().includes(valor));
        render(filtered);
        return;
      }
      const filtered = cache.filter((item) => columns.some((col) => String(item[col] ?? '').toLowerCase().includes(valor)));
      render(filtered);
    };

    filtersForm.addEventListener('submit', (event) => {
      event.preventDefault();
      applyFilter();
    });

    const loadProducts = async () => {
      listStatus.textContent = 'Cargando productos...';
      try {
        const response = await fetch('/api/productos');
        if (!response.ok) throw new Error('No se pudo obtener la lista');
        const data = await response.json();
        cache = Array.isArray(data.rows) ? data.rows : [];
        render(cache);
        listStatus.textContent = 'Productos cargados';
      } catch (error) {
        body.innerHTML = '<tr><td colspan="12">No se pudo cargar la lista de productos.</td></tr>';
        listStatus.textContent = error.message;
        listStatus.className = 'status error';
      }
    };

    loadProducts();
  </script>
</body>
</html>
